# Publish docs to Wiki
#
# This workflow publishes generated documentation to GitHub wiki repositories.
#
# PREREQUISITES:
# - Target wikis must be initialized with at least one page (e.g., a Home page).
# - For NanashiTheNameless/OrcaSlicer_WIKI.wiki: uses GITHUB_TOKEN (no setup needed).
# - For NanashiTheNameless/OrcaSlicer.wiki: requires a Personal Access Token (PAT) 
#   with 'repo' scope stored as the repository secret ORCASLICER_PAT.
#   If not set, the OrcaSlicer.wiki push is skipped without failing the workflow.
#
# USAGE:
# - This workflow assumes docs are generated or exist in ./docs directory.
# - If you have a build step to generate docs, add it before the copy steps.

name: Publish docs to Wiki

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  publish:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    env:
      ORCASLICER_PAT: ${{ secrets.ORCASLICER_PAT }}
    steps:
      - name: Ensure ORCASLICER_PAT is set
        run: |
          if [ -z "${ORCASLICER_PAT}" ]; then
            echo "Secret ORCASLICER_PAT is not set."
            echo "Create a Personal Access Token (PAT) with 'repo' scope and add it as ORCASLICER_PAT in repository secrets."
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      # NOTE: Ensure your docs are generated into ./docs before the following steps.
      # If you have a build step to generate docs, insert it here.

      - name: Checkout target wiki (OrcaSlicer_WIKI)
        uses: actions/checkout@v4
        with:
          repository: NanashiTheNameless/OrcaSlicer_WIKI.wiki
          token: ${{ env.ORCASLICER_PAT }}
          path: wiki_orca_wiki

      - name: Sync content to OrcaSlicer_WIKI.wiki and push if changed
        run: |
          if [ -d docs ]; then SRC_DIR="docs"; else SRC_DIR="."; fi
          echo "Using source: $SRC_DIR"
          rsync -av --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude '.gitignore' \
            --exclude '.gitattributes' \
            --exclude 'README.md' \
            --exclude 'LICENSE' \
            "$SRC_DIR"/ wiki_orca_wiki/
          cd wiki_orca_wiki
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "Update OrcaSlicer_WIKI wiki from OrcaSlicer_WIKI"
            git push
          else
            echo "No changes to commit to OrcaSlicer_WIKI.wiki"
          fi

      - name: Checkout target wiki (OrcaSlicer)
        uses: actions/checkout@v4
        with:
          repository: NanashiTheNameless/OrcaSlicer.wiki
          token: ${{ env.ORCASLICER_PAT }}
          path: wiki_orca

      - name: Sync content to OrcaSlicer.wiki and push if changed
        run: |
          if [ -d docs ]; then SRC_DIR="docs"; else SRC_DIR="."; fi
          echo "Using source: $SRC_DIR"
          rsync -av --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude '.gitignore' \
            --exclude '.gitattributes' \
            --exclude 'README.md' \
            --exclude 'LICENSE' \
            "$SRC_DIR"/ wiki_orca/
          cd wiki_orca
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "Update OrcaSlicer wiki from OrcaSlicer_WIKI"
            git push
          else
            echo "No changes to commit to OrcaSlicer.wiki"
          fi
